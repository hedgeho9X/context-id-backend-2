<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casdoor è®¤è¯æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.success:hover {
            background: #218838;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .info-box.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .info-box.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .user-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .user-details {
            display: inline-block;
            vertical-align: middle;
        }
        
        .user-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .user-email {
            color: #666;
        }
        
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Casdoor è®¤è¯æµ‹è¯•</h1>
            <p>æµ‹è¯•ç™»å½•æ³¨å†Œæµç¨‹å’Œç”¨æˆ·ä¿¡æ¯è·å–</p>
        </div>
        
        <div class="content">
            <!-- è®¤è¯çŠ¶æ€ -->
            <div class="test-section">
                <div class="section-title">è®¤è¯çŠ¶æ€</div>
                <div id="auth-status">
                    <span>å½“å‰çŠ¶æ€: </span>
                    <span id="status-text">æœªç™»å½•</span>
                    <span id="status-indicator" class="status">âŒ</span>
                </div>
                <div class="button-group">
                    <button class="btn secondary" onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
                    <button class="btn secondary" onclick="clearStorage()">æ¸…é™¤æœ¬åœ°æ•°æ®</button>
                </div>
            </div>
            
            <!-- è·å–è®¤è¯URL -->
            <div class="test-section">
                <div class="section-title">1. è·å– Casdoor è®¤è¯ URL</div>
                <div class="button-group">
                    <button class="btn" onclick="getAuthUrl()">è·å–ç™»å½•URL</button>
                    <button class="btn" onclick="getSignupUrl()">è·å–æ³¨å†ŒURL</button>
                </div>
                <div id="auth-url-result" class="info-box hidden"></div>
            </div>
            
            <!-- è·³è½¬åˆ°è®¤è¯é¡µé¢ -->
            <div class="test-section">
                <div class="section-title">2. è·³è½¬åˆ° Casdoor è®¤è¯é¡µé¢</div>
                <div class="button-group">
                    <a id="login-link" class="btn success hidden" target="_blank">ğŸ”— æ‰“å¼€ç™»å½•é¡µé¢</a>
                    <a id="signup-link" class="btn success hidden" target="_blank">ğŸ”— æ‰“å¼€æ³¨å†Œé¡µé¢</a>
                </div>
                <div class="info-box">
                    <strong>è¯´æ˜:</strong> ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥å°†åœ¨æ–°çª—å£æ‰“å¼€ Casdoor è®¤è¯é¡µé¢ã€‚å®Œæˆè®¤è¯åï¼Œä¼šé‡å®šå‘å›æœ¬é¡µé¢ã€‚
                </div>
            </div>
            
            <!-- å¤„ç†å›è°ƒ -->
            <div class="test-section">
                <div class="section-title">3. è®¤è¯å›è°ƒå¤„ç†</div>
                <div id="callback-info" class="info-box">
                    ç­‰å¾…è®¤è¯å›è°ƒ...
                </div>
                <div class="button-group">
                    <button class="btn" onclick="handleCallback()">æ‰‹åŠ¨å¤„ç†å›è°ƒ</button>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
            <div class="test-section">
                <div class="section-title">4. ç”¨æˆ·ä¿¡æ¯</div>
                <div id="user-info-section" class="hidden">
                    <div class="user-info" id="user-display"></div>
                    <div class="button-group">
                        <button class="btn" onclick="refreshUserInfo()">åˆ·æ–°ç”¨æˆ·ä¿¡æ¯</button>
                        <button class="btn secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
                    </div>
                </div>
                <div id="no-user-info" class="info-box">
                    æš‚æ— ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆå®Œæˆè®¤è¯æµç¨‹ã€‚
                </div>
            </div>
            
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div class="test-section">
                <div class="section-title">è°ƒè¯•ä¿¡æ¯</div>
                <div class="button-group">
                    <button class="btn secondary" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
                    <button class="btn secondary" onclick="clearDebugInfo()">æ¸…é™¤è°ƒè¯•ä¿¡æ¯</button>
                </div>
                <div id="debug-info" class="code-block hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            backendUrl: 'http://localhost:8080',
            casdoorUrl: 'http://localhost:8000',
            redirectUri: window.location.origin + window.location.pathname,
            clientId: '87e7e4048518f0347d16',
            organization: 'built-in'
        };
        
        // è°ƒè¯•æ—¥å¿—
        let debugLogs = [];
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry, data);
            debugLogs.push(logEntry + (data ? '\n' + JSON.stringify(data, null, 2) : ''));
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (debugLogs.length > 50) {
                debugLogs.shift();
            }
        }
        
        // æ˜¾ç¤º/éšè—å…ƒç´ 
        function show(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }
        
        function hide(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }
        
        // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
        function updateAuthStatus(isAuthenticated, userInfo = null) {
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (isAuthenticated) {
                statusText.textContent = `å·²ç™»å½• (${userInfo?.username || 'æœªçŸ¥ç”¨æˆ·'})`;
                statusIndicator.textContent = 'âœ…';
                statusIndicator.className = 'status success';
            } else {
                statusText.textContent = 'æœªç™»å½•';
                statusIndicator.textContent = 'âŒ';
                statusIndicator.className = 'status error';
            }
        }
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuthStatus() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    updateAuthStatus(false);
                    return false;
                }
                
                log('æ£€æŸ¥è®¤è¯çŠ¶æ€', { hasToken: !!token });
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/user`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    updateAuthStatus(true, userInfo);
                    displayUserInfo(userInfo);
                    return true;
                } else {
                    // Token å¯èƒ½å·²è¿‡æœŸ
                    localStorage.removeItem('auth_token');
                    updateAuthStatus(false);
                    return false;
                }
            } catch (error) {
                log('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥', error);
                updateAuthStatus(false);
                return false;
            }
        }
        
        // è·å–è®¤è¯URL
        async function getAuthUrl() {
            try {
                log('è·å–è®¤è¯URL');
                
                const state = generateRandomString(32);
                localStorage.setItem('auth_state', state);
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/url?` + new URLSearchParams({
                    redirect_uri: CONFIG.redirectUri,
                    state: state
                }));
                
                if (response.ok) {
                    const data = await response.json();
                    log('è·å–è®¤è¯URLæˆåŠŸ', data);
                    
                    const loginUrl = data.data?.login_url || data.url;
                    document.getElementById('auth-url-result').innerHTML = 
                        `<strong>ç™»å½•URL:</strong><br><div class="code-block">${loginUrl}</div>`;
                    show('auth-url-result');
                    
                    document.getElementById('login-link').href = loginUrl;
                    show('login-link');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log('è·å–è®¤è¯URLå¤±è´¥', error);
                document.getElementById('auth-url-result').innerHTML = 
                    `<div class="info-box error">è·å–è®¤è¯URLå¤±è´¥: ${error.message}</div>`;
                show('auth-url-result');
            }
        }
        
        // è·å–æ³¨å†ŒURL
        async function getSignupUrl() {
            try {
                log('è·å–æ³¨å†ŒURL');
                
                const state = generateRandomString(32);
                localStorage.setItem('auth_state', state);
                
                // æ„å»ºæ³¨å†ŒURL
                const signupUrl = `${CONFIG.casdoorUrl}/signup/${CONFIG.organization}?` + new URLSearchParams({
                    redirect_uri: CONFIG.redirectUri,
                    state: state,
                    response_type: 'code',
                    client_id: CONFIG.clientId,
                    scope: 'openid profile email'
                });
                
                log('æ³¨å†ŒURLæ„å»ºæˆåŠŸ', { url: signupUrl });
                
                document.getElementById('auth-url-result').innerHTML = 
                    `<strong>æ³¨å†ŒURL:</strong><br><div class="code-block">${signupUrl}</div>`;
                show('auth-url-result');
                
                document.getElementById('signup-link').href = signupUrl;
                show('signup-link');
            } catch (error) {
                log('è·å–æ³¨å†ŒURLå¤±è´¥', error);
                document.getElementById('auth-url-result').innerHTML = 
                    `<div class="info-box error">è·å–æ³¨å†ŒURLå¤±è´¥: ${error.message}</div>`;
                show('auth-url-result');
            }
        }
        
        // å¤„ç†è®¤è¯å›è°ƒ
        async function handleCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const storedState = localStorage.getItem('auth_state');
                
                log('å¤„ç†è®¤è¯å›è°ƒ', { code, state, storedState });
                
                if (!code) {
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box error">æœªæ‰¾åˆ°è®¤è¯ä»£ç ï¼Œè¯·å…ˆå®Œæˆè®¤è¯æµç¨‹ã€‚</div>';
                    return;
                }
                
                if (state && storedState && state !== storedState) {
                    log('çŠ¶æ€éªŒè¯è­¦å‘Š', { received: state, expected: storedState });
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box error">çŠ¶æ€éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­å¤„ç†è®¤è¯ã€‚æ¥æ”¶åˆ°çš„state: ' + state + '</div>';
                    // ä¸è¦è¿”å›ï¼Œç»§ç»­å¤„ç†è®¤è¯
                }
                
                document.getElementById('callback-info').innerHTML = 
                    '<div class="info-box">æ­£åœ¨å¤„ç†è®¤è¯å›è°ƒ...</div>';
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        state: state
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('è®¤è¯å›è°ƒæˆåŠŸ', data);
                    
                    // ä¿å­˜token
                    const token = data.data?.token || data.token;
                    const user = data.data?.user || data.user;
                    
                    localStorage.setItem('auth_token', token);
                    localStorage.removeItem('auth_state');
                    
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box success">è®¤è¯æˆåŠŸï¼æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...</div>';
                    
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    displayUserInfo(user);
                    updateAuthStatus(true, user);
                    
                    // æ¸…é™¤URLå‚æ•°
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                log('å¤„ç†è®¤è¯å›è°ƒå¤±è´¥', error);
                document.getElementById('callback-info').innerHTML = 
                    `<div class="info-box error">è®¤è¯å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo(userInfo) {
            if (!userInfo) return;
            
            const userDisplay = document.getElementById('user-display');
            userDisplay.innerHTML = `
                <img src="${userInfo.avatar || 'https://via.placeholder.com/60'}" 
                     alt="ç”¨æˆ·å¤´åƒ" class="user-avatar" 
                     onerror="this.src='https://via.placeholder.com/60'">
                <div class="user-details">
                    <div class="user-name">${userInfo.displayName || userInfo.username}</div>
                    <div class="user-email">${userInfo.email}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ID: ${userInfo.id} | ç»„ç»‡: ${userInfo.organization || 'built-in'}
                    </div>
                </div>
            `;
            
            show('user-info-section');
            hide('no-user-info');
            
            log('æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯', userInfo);
        }
        
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        async function refreshUserInfo() {
            const isAuthenticated = await checkAuthStatus();
            if (!isAuthenticated) {
                hide('user-info-section');
                show('no-user-info');
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_state');
            updateAuthStatus(false);
            hide('user-info-section');
            show('no-user-info');
            document.getElementById('callback-info').innerHTML = 'ç­‰å¾…è®¤è¯å›è°ƒ...';
            log('ç”¨æˆ·é€€å‡ºç™»å½•');
        }
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        function clearStorage() {
            localStorage.clear();
            updateAuthStatus(false);
            hide('user-info-section');
            show('no-user-info');
            document.getElementById('callback-info').innerHTML = 'ç­‰å¾…è®¤è¯å›è°ƒ...';
            log('æ¸…é™¤æœ¬åœ°å­˜å‚¨');
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            document.getElementById('debug-info').textContent = debugLogs.join('\n\n');
            show('debug-info');
        }
        
        // æ¸…é™¤è°ƒè¯•ä¿¡æ¯
        function clearDebugInfo() {
            debugLogs = [];
            hide('debug-info');
        }
        
        // ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('code')) {
                handleCallback();
            } else {
                checkAuthStatus();
            }
        };
    </script>
</body>
</html>
