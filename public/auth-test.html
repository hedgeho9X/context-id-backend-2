<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casdoor 认证测试页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.success:hover {
            background: #218838;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.secondary:hover {
            background: #5a6268;
        }
        
        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .info-box.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .info-box.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .user-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            vertical-align: middle;
        }
        
        .user-details {
            display: inline-block;
            vertical-align: middle;
        }
        
        .user-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .user-email {
            color: #666;
        }
        
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 Casdoor 认证测试</h1>
            <p>测试登录注册流程和用户信息获取</p>
        </div>
        
        <div class="content">
            <!-- 认证状态 -->
            <div class="test-section">
                <div class="section-title">认证状态</div>
                <div id="auth-status">
                    <span>当前状态: </span>
                    <span id="status-text">未登录</span>
                    <span id="status-indicator" class="status">❌</span>
                </div>
                <div class="button-group">
                    <button class="btn secondary" onclick="checkAuthStatus()">检查认证状态</button>
                    <button class="btn secondary" onclick="clearStorage()">清除本地数据</button>
                </div>
            </div>
            
            <!-- 获取认证URL -->
            <div class="test-section">
                <div class="section-title">1. 获取 Casdoor 认证 URL</div>
                <div class="button-group">
                    <button class="btn" onclick="getAuthUrl()">获取登录URL</button>
                    <button class="btn" onclick="getSignupUrl()">获取注册URL</button>
                </div>
                <div id="auth-url-result" class="info-box hidden"></div>
            </div>
            
            <!-- 跳转到认证页面 -->
            <div class="test-section">
                <div class="section-title">2. 跳转到 Casdoor 认证页面</div>
                <div class="button-group">
                    <a id="login-link" class="btn success hidden" target="_blank">🔗 打开登录页面</a>
                    <a id="signup-link" class="btn success hidden" target="_blank">🔗 打开注册页面</a>
                </div>
                <div class="info-box">
                    <strong>说明:</strong> 点击上面的链接将在新窗口打开 Casdoor 认证页面。完成认证后，会重定向回本页面。
                </div>
            </div>
            
            <!-- 处理回调 -->
            <div class="test-section">
                <div class="section-title">3. 认证回调处理</div>
                <div id="callback-info" class="info-box">
                    等待认证回调...
                </div>
                <div class="button-group">
                    <button class="btn" onclick="handleCallback()">手动处理回调</button>
                </div>
            </div>
            
            <!-- 用户信息显示 -->
            <div class="test-section">
                <div class="section-title">4. 用户信息</div>
                <div id="user-info-section" class="hidden">
                    <div class="user-info" id="user-display"></div>
                    <div class="button-group">
                        <button class="btn" onclick="refreshUserInfo()">刷新用户信息</button>
                        <button class="btn secondary" onclick="logout()">退出登录</button>
                    </div>
                </div>
                <div id="no-user-info" class="info-box">
                    暂无用户信息，请先完成认证流程。
                </div>
            </div>
            
            <!-- 调试信息 -->
            <div class="test-section">
                <div class="section-title">调试信息</div>
                <div class="button-group">
                    <button class="btn secondary" onclick="showDebugInfo()">显示调试信息</button>
                    <button class="btn secondary" onclick="clearDebugInfo()">清除调试信息</button>
                </div>
                <div id="debug-info" class="code-block hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // 配置
        const CONFIG = {
            backendUrl: 'http://localhost:8080',
            casdoorUrl: 'http://localhost:8000',
            redirectUri: window.location.origin + window.location.pathname,
            clientId: '87e7e4048518f0347d16',
            organization: 'built-in'
        };
        
        // 调试日志
        let debugLogs = [];
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry, data);
            debugLogs.push(logEntry + (data ? '\n' + JSON.stringify(data, null, 2) : ''));
            
            // 限制日志数量
            if (debugLogs.length > 50) {
                debugLogs.shift();
            }
        }
        
        // 显示/隐藏元素
        function show(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }
        
        function hide(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }
        
        // 更新认证状态显示
        function updateAuthStatus(isAuthenticated, userInfo = null) {
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.getElementById('status-indicator');
            
            if (isAuthenticated) {
                statusText.textContent = `已登录 (${userInfo?.username || '未知用户'})`;
                statusIndicator.textContent = '✅';
                statusIndicator.className = 'status success';
            } else {
                statusText.textContent = '未登录';
                statusIndicator.textContent = '❌';
                statusIndicator.className = 'status error';
            }
        }
        
        // 检查认证状态
        async function checkAuthStatus() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    updateAuthStatus(false);
                    return false;
                }
                
                log('检查认证状态', { hasToken: !!token });
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/user`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    updateAuthStatus(true, userInfo);
                    displayUserInfo(userInfo);
                    return true;
                } else {
                    // Token 可能已过期
                    localStorage.removeItem('auth_token');
                    updateAuthStatus(false);
                    return false;
                }
            } catch (error) {
                log('检查认证状态失败', error);
                updateAuthStatus(false);
                return false;
            }
        }
        
        // 获取认证URL
        async function getAuthUrl() {
            try {
                log('获取认证URL');
                
                const state = generateRandomString(32);
                localStorage.setItem('auth_state', state);
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/url?` + new URLSearchParams({
                    redirect_uri: CONFIG.redirectUri,
                    state: state
                }));
                
                if (response.ok) {
                    const data = await response.json();
                    log('获取认证URL成功', data);
                    
                    const loginUrl = data.data?.login_url || data.url;
                    document.getElementById('auth-url-result').innerHTML = 
                        `<strong>登录URL:</strong><br><div class="code-block">${loginUrl}</div>`;
                    show('auth-url-result');
                    
                    document.getElementById('login-link').href = loginUrl;
                    show('login-link');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log('获取认证URL失败', error);
                document.getElementById('auth-url-result').innerHTML = 
                    `<div class="info-box error">获取认证URL失败: ${error.message}</div>`;
                show('auth-url-result');
            }
        }
        
        // 获取注册URL
        async function getSignupUrl() {
            try {
                log('获取注册URL');
                
                const state = generateRandomString(32);
                localStorage.setItem('auth_state', state);
                
                // 构建注册URL
                const signupUrl = `${CONFIG.casdoorUrl}/signup/${CONFIG.organization}?` + new URLSearchParams({
                    redirect_uri: CONFIG.redirectUri,
                    state: state,
                    response_type: 'code',
                    client_id: CONFIG.clientId,
                    scope: 'openid profile email'
                });
                
                log('注册URL构建成功', { url: signupUrl });
                
                document.getElementById('auth-url-result').innerHTML = 
                    `<strong>注册URL:</strong><br><div class="code-block">${signupUrl}</div>`;
                show('auth-url-result');
                
                document.getElementById('signup-link').href = signupUrl;
                show('signup-link');
            } catch (error) {
                log('获取注册URL失败', error);
                document.getElementById('auth-url-result').innerHTML = 
                    `<div class="info-box error">获取注册URL失败: ${error.message}</div>`;
                show('auth-url-result');
            }
        }
        
        // 处理认证回调
        async function handleCallback() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const storedState = localStorage.getItem('auth_state');
                
                log('处理认证回调', { code, state, storedState });
                
                if (!code) {
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box error">未找到认证代码，请先完成认证流程。</div>';
                    return;
                }
                
                if (state && storedState && state !== storedState) {
                    log('状态验证警告', { received: state, expected: storedState });
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box error">状态验证失败，但继续处理认证。接收到的state: ' + state + '</div>';
                    // 不要返回，继续处理认证
                }
                
                document.getElementById('callback-info').innerHTML = 
                    '<div class="info-box">正在处理认证回调...</div>';
                
                const response = await fetch(`${CONFIG.backendUrl}/api/v1/auth/callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        state: state
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('认证回调成功', data);
                    
                    // 保存token
                    const token = data.data?.token || data.token;
                    const user = data.data?.user || data.user;
                    
                    localStorage.setItem('auth_token', token);
                    localStorage.removeItem('auth_state');
                    
                    document.getElementById('callback-info').innerHTML = 
                        '<div class="info-box success">认证成功！正在获取用户信息...</div>';
                    
                    // 显示用户信息
                    displayUserInfo(user);
                    updateAuthStatus(true, user);
                    
                    // 清除URL参数
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }
            } catch (error) {
                log('处理认证回调失败', error);
                document.getElementById('callback-info').innerHTML = 
                    `<div class="info-box error">认证失败: ${error.message}</div>`;
            }
        }
        
        // 显示用户信息
        function displayUserInfo(userInfo) {
            if (!userInfo) return;
            
            const userDisplay = document.getElementById('user-display');
            userDisplay.innerHTML = `
                <img src="${userInfo.avatar || 'https://via.placeholder.com/60'}" 
                     alt="用户头像" class="user-avatar" 
                     onerror="this.src='https://via.placeholder.com/60'">
                <div class="user-details">
                    <div class="user-name">${userInfo.displayName || userInfo.username}</div>
                    <div class="user-email">${userInfo.email}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ID: ${userInfo.id} | 组织: ${userInfo.organization || 'built-in'}
                    </div>
                </div>
            `;
            
            show('user-info-section');
            hide('no-user-info');
            
            log('显示用户信息', userInfo);
        }
        
        // 刷新用户信息
        async function refreshUserInfo() {
            const isAuthenticated = await checkAuthStatus();
            if (!isAuthenticated) {
                hide('user-info-section');
                show('no-user-info');
            }
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_state');
            updateAuthStatus(false);
            hide('user-info-section');
            show('no-user-info');
            document.getElementById('callback-info').innerHTML = '等待认证回调...';
            log('用户退出登录');
        }
        
        // 清除本地存储
        function clearStorage() {
            localStorage.clear();
            updateAuthStatus(false);
            hide('user-info-section');
            show('no-user-info');
            document.getElementById('callback-info').innerHTML = '等待认证回调...';
            log('清除本地存储');
        }
        
        // 显示调试信息
        function showDebugInfo() {
            document.getElementById('debug-info').textContent = debugLogs.join('\n\n');
            show('debug-info');
        }
        
        // 清除调试信息
        function clearDebugInfo() {
            debugLogs = [];
            hide('debug-info');
        }
        
        // 生成随机字符串
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // 页面加载时初始化
        window.onload = function() {
            log('页面加载完成');
            
            // 检查是否有回调参数
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('code')) {
                handleCallback();
            } else {
                checkAuthStatus();
            }
        };
    </script>
</body>
</html>
